# bilibili api

## 投稿时间排序-分页搜索

```http request
https://api.bilibili.com/x/web-interface/newlist?rid=24&type=0&pn=1&ps=20&jsonp=jsonp
```

- pn 页码
- ps 上限为50。默认为20。

实际上，b站MAD区最早稿件时间为 2009-07-15 15:12:48。那么 [2009-07-15, 2021-11-4]这个时间区间，大约12年左右，一共12*365=4380天。
80W/4380约等于183，也就是平均每天大约200份稿件的数量级。

### 避免重复记录插入数据库

问题描述：分析爬虫过程中，页数推移会导致部分页面抓取的数据会发生重复。

举例：开始时，假设页数总数为40000，每页20条数据，刚好800000条数据。 数据分布：

```
A1...A20|A21...A40|A41-...-A800000
```

- 爬虫抓取第1页。爬虫休息一下。
- b站数据更新，现在总页数变为40001,，添加数据5条，为N1...N5。

那么数据分布现在是：

```
N1...N5 A1...A15|A16...A35|A36...A80000
```

- 此时爬虫开始抓取第2页，也就是A16...A35。这和之前抓取的第一页有重叠：

```
A1.........................A20.A21..............................A41
|-----------------------------|<---------------------------------->|
                                       理论上要抓取的第2页

N1...N5.A1..................【A16......A20】.A21....................A35.........A41
|---------------------------|<---------------------------------->|
                                        当前抓取第2页
```

- 重叠部分为A16...A20。一共就是5个稿件，原因就是因为N1...N5这5个新稿件的发布对数据部分产生推移。

**上面只是一个例子推演，新稿件的发布数量以及发布时间都是不可知的。绝不能对此有所假设。**

明白这个现象的存在性非常必要。此时可以考虑如何避免数据库插入重复数据。这个逻辑可以在应用层，或者在数据库层进行处理。

在应用层主动筛选抛弃：
1. 应用层代码在抓取当前页数据后，保存这一页全部视频的ID到一个id_array中。例如，[A1...A20]。 
2. 抓取下一页后，将抓取到的视频id 列表和这个id_array比较，如果已经存在，那就抛弃这条数据。插入剩余数据到数据库后，更新id_array。
   以此类推。

或者在数据库层挑选插入：
1. 应用层不去关心数据有没重复，使用mongodb的upsert功能，设置upsert为true。
   查询特定数据，如果已存在，那就不插入，否则就插入该条数据。这个机制，依赖的是数据库的挑选插入功能。

或者利用数据库的唯一索引进行暴力约束：
1. 因为视频ID必然唯一。那么定义schema model时设置视频ID为unique。这样，重复数据是无法插入的。这是数据库系统规范对你的承诺。

这三种方式都是可行的。基于简单考虑，使用2+3的策略。
- 使用【当不存在就新增，存在则更新】的批量更新策略。
- 对数据库模型定义添加视频ID唯一的索引约束。(可选)

### 分页的尽头
```http request
https://api.bilibili.com/x/web-interface/newlist?rid=24&type=0&pn=50000&ps=20
```

pn=50000&ps=20 条件下，pn=50000大于目前数据总数。返回的结果为：
```json
{
  "code": 0,
  "message": "0",
  "ttl": 1,
  "data": {
    "archives": [
      
    ],
    "page": {
      "count": 0,
      "num": 50000,
      "size": 20
    }
  }
}
```
那么程序需要进行archives的长度判断。

## 视频热度排序-按日期范围搜索

这个api非常好用，能够避免分页搜索随时间推移产生的重复问题。

```
https://s.search.bilibili.com/cate/search?main_ver=v3&search_type=video&view_type=hot_rank&order=click&copy_right=-1
&cate_id=24&page=1&pagesize=20&jsonp=jsonp&time_from=20211103&time_to=20211103
```

例如 time_from=20211103&time_to=20211103 表示20211103这天的MAD稿件。

返回的结果中，有三个重要字段。

- "numPages": 3,
- "numResults": 53,
- "pagesize": 20,

如果pagesize为20，稿件数为53。则会分为3页，分别是20,20,13。



